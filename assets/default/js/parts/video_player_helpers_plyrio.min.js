/******/ (() => { // webpackBootstrap
var __webpack_exports__ = {};
/*!****************************************************!*\
  !*** ./resources/js/parts/video_player_helpers.js ***!
  \****************************************************/
var fileVideoPlayer;

/**
 * Extract YouTube video ID from any URL format (long or short)
 */
function extractYouTubeId(url) {
  let id = '';

  // لو الرابط فيه ?v=
  const vParam = url.match(/[?&]v=([^&#]+)/);
  if (vParam) {
    id = vParam[1];
  } else {
    // لو الرابط من youtu.be أو أي شكل فيه الـ ID بعد الـ /
    id = url.split('/').pop().split('?')[0];
  }

  return id;
}

/**
 * Generates Plyr-compatible HTML, including a wrapper.
 */
window.makeVideoPlayerHtml = function (path, storage, height, tagId) {
  var html = '';

  // For YouTube and Vimeo, create the Plyr div structure inside a wrapper
  if (storage === 'youtube' || storage === 'vimeo') {
    // ✅ تعديل هنا لاستخراج الـ Video ID بشكل صحيح من أي رابط
    var videoId = (storage === 'youtube') ? extractYouTubeId(path) : path.split('/').pop().split('?')[0];

    // The wrapper for positioning context
    html = '<div class="player-wrapper" style="">' +
           // ✅ التعديل هنا: استخدام youtube-nocookie.com كجزء من مسار Plyr
           '<div id="' + tagId + '" data-plyr-provider="' + storage + '" data-plyr-embed-id="' + videoId + '" data-plyr-config=\'{"youtube":{"noCookie":true}}\'></div>' +
           '</div>';
  }
  // For secure_host, we still use an iframe (no wrapper needed)
  else if (storage === "secure_host") {
    html = '<iframe src="' + path + '" style="width: 100%;  border: 0;" class="img-cover bg-gray200" frameborder="0" allowfullscreen="true" ></iframe>';
  }
  // For local files, create the standard video tag inside a wrapper
  else {
    html = '<div class="player-wrapper" style="">' +
           '<video id="' + tagId + '" oncontextmenu="return false;" controlsList="nodownload" playsinline controls width="100%">' +
           '<source src="' + path + '" type="video/mp4"/>' +
           '</video>' +
           '</div>';
  }

  return {
    html: html
  };
};

window.handleVideoByFileId = function (fileId, $contentEl, callback) {
  closeVideoPlayer();
  var height = $(window).width() > 991 ? 426 : 264;

  $.post('/course/getFilePath', {
    file_id: fileId
  }, function (result) {
    if (result && result.code === 200) {
      var storage = result.storage;
      var videoTagId = 'videoPlayer' + fileId;
      var html = makeVideoPlayerHtml(result.path, storage, height, videoTagId).html;

      $contentEl.html(html);

      if (storage !== "secure_host") {
        fileVideoPlayer = new Plyr('#' + videoTagId, {
          seekTime: 10,
          youtube: {
            controls: 0,
            disablekb: 1,
            modestbranding: 1
          },
          controls: [
            'play-large',
            'rewind',
            'play',
            'fast-forward',
            'progress',
            'current-time',
            'mute',
            'volume',
            'captions',
            'settings',
            'pip',
            'airplay',
            'fullscreen'
          ]
        });

        fileVideoPlayer.on('ready', function(event) {
          var instance = event.detail.plyr;
          if (instance.isYouTube) {
            var overlay = document.createElement('div');
            overlay.className = 'plyr__video-overlay';
            instance.elements.container.appendChild(overlay);

            // ميزة النقر للتشغيل/الإيقاف
            overlay.addEventListener('click', function() {
              instance.togglePlay();
            });
          }
        });

      }
      callback();
    } else {
      $.toast({
        heading: notAccessToastTitleLang,
        text: notAccessToastMsgLang,
        bgColor: '#f63c3c',
        textColor: 'white',
        hideAfter: 10000,
        position: 'bottom-right',
        icon: 'error'
      });
    }
  }).fail(function (err) {
    $.toast({
      heading: notAccessToastTitleLang,
      text: notAccessToastMsgLang,
      bgColor: '#f63c3c',
      textColor: 'white',
      hideAfter: 10000,
      position: 'bottom-right',
      icon: 'error'
    });
  });
};

window.closeVideoPlayer = function () {
  if (fileVideoPlayer && typeof fileVideoPlayer.destroy === 'function') {
    fileVideoPlayer.destroy();
  }
};

window.pauseVideoPlayer = function () {
  if (fileVideoPlayer && typeof fileVideoPlayer.pause === 'function') {
    fileVideoPlayer.pause();
  }
};
/******/ })()
;
